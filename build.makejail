INCLUDE options/options.makejail
INCLUDE options/volumes.makejail

ARG inventree_version=0.13.3
ARG inventree_enable_pgsql=1
ARG inventree_enable_mysql=1

# Build and/or runtime dependencies.
PKG dasel gettext python py39-invoke py39-sqlite3 pango rust

# Pillow.
CMD --local ./install-pillow.sh "${APPJAIL_JAILNAME}"

RAW if [ "${inventree_enable_pgsql}" != 0 ]; then
	PKG py39-psycopg2
RAW fi

RAW if [ "${inventree_enable_mysql}" != 0 ]; then
	PKG py39-mysqlclient
RAW fi

# Create inventree user.
CMD pw useradd -n inventree -d /inventree -s /bin/sh
CMD mkdir -p /inventree
# Copy dot files.
COPY files/dot.profile /inventree/.profile
COPY files/dot.shrc /inventree/.shrc
# Fix permissions.
CMD chown -R inventree:inventree /inventree

# Use inventree user to work in its home directory.
USER inventree
WORKDIR /inventree

# Bootstrap pip.
RUN python -m ensurepip --default-pip
RUN python -m pip install --upgrade pip

# Download and install InvenTree.
CMD fetch -o /tmp/inventree.tar.gz https://github.com/inventree/InvenTree/archive/refs/tags/${inventree_version}.tar.gz
CMD mkdir -p /inventree/src
CMD tar -C /inventree/src --strip-components=1 -xf /tmp/inventree.tar.gz
# Patch to fix InvenTree/InvenTree/settings.py.
COPY files/patch-InvenTree-InvenTree-settings.py.patch src
CMD cd /inventree/src; patch < patch-InvenTree-InvenTree-settings.py.patch
CMD rm -f /inventree/src/InvenTree/InvenTree/settings.py.orig
CMD rm -f /inventree/src/patch-InvenTree-InvenTree-settings.py.patch
# Fix permissions to the source tree.
CMD chown -R inventree:inventree /inventree/src
# Remove tarball.
CMD rm -f /tmp/inventree.tar.gz

# Install more dependencies.
RUN python -m pip install -r src/requirements.txt

# Remove rust, at it is not necessary.
PKG --remove rust
PKG --autoremove
